pipeline {
  agent any

    options {
    timestamps()
    ansiColor('xterm')
  }

  environment {
    APP_COMPOSE = 'flights-project/docker-compose.yml'
    MINIO_ALIAS = 'local'
    MINIO_URL   = 'http://minio:9000'
    MINIO_USER  = 'minioadmin'
    MINIO_PASS  = 'minioadmin'
    MINIO_BUCKET= 'flights-data'   
    APP_NET     = 'flightsnet'     // <-- Ï„Î¿ ÏƒÏ„Î±Î¸ÎµÏÏŒ ÏŒÎ½Î¿Î¼Î± Î´Î¹ÎºÏ„ÏÎ¿Ï… Î±Ï€ÏŒ Ï„Î¿ compose
  }

  stages {
    stage('Build app image') {
      steps {
        sh 'docker compose -f ${APP_COMPOSE} build --pull'
      }
    }

    stage('Compose Up') {
      steps {
        sh '''
          set -e

          docker volume create flights-project_node_red_data >/dev/null 2>&1 || true
          docker run --rm -v flights-project_node_red_data:/data alpine sh -c "chown -R 1000:1000 /data || true"
          docker compose -f ${APP_COMPOSE} up -d --wait || true

          i=0
          while [ $i -lt 60 ]; do
            s=$(docker inspect --format='{{.State.Health.Status}}' mynodered 2>/dev/null || echo "missing")
            if [ "$s" = "healthy" ]; then
              echo "Node-RED is healthy âœ…"
              exit 0
            fi
            sleep 2
            i=$((i+1))
          done

          echo "âŒ Node-RED stayed unhealthy. Last 200 lines of logs:"
          docker logs --tail=200 mynodered || true
          exit 1
        '''
      }
    }

    stage('Prep MinIO (bucket)') {
      steps {
        sh '''
          # config cache Î³Î¹Î± Ï„Î¿ mc ÏÏƒÏ„Îµ Î½Î± ÎºÏÎ±Ï„Î¬ÎµÎ¹ Ï„Î¿ alias Î¼ÎµÏ„Î±Î¾Ï runs
          docker volume create mcconfig >/dev/null 2>&1 || true

          # set alias
          docker run --rm --network ${APP_NET} -v mcconfig:/root/.mc \
            minio/mc alias set ${MINIO_ALIAS} ${MINIO_URL} ${MINIO_USER} ${MINIO_PASS}

          # make bucket (no-op Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹)
          docker run --rm --network ${APP_NET} -v mcconfig:/root/.mc \
            minio/mc mb -p ${MINIO_ALIAS}/${MINIO_BUCKET} || true

          # Î»Î¯ÏƒÏ„Î± Î³Î¹Î± ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·
          docker run --rm --network ${APP_NET} -v mcconfig:/root/.mc \
            minio/mc ls ${MINIO_ALIAS}
        '''
      }
    }

    stage('Smoke checks') {
      steps {
        sh '''
          # Node-RED UI
          docker run --rm --network ${APP_NET} curlimages/curl:8.10.1 \
            -fsS http://mynodered:1880 >/dev/null

          # MinIO Console
          docker run --rm --network ${APP_NET} curlimages/curl:8.10.1 \
            -fsS http://myminio:9001 >/dev/null
        '''
      }
    }

    stage('Integration test (flow â†’ MinIO)') {
      steps {
        sh '''
          # Î†Ï†Î·ÏƒÎµ Ï„Î· ÏÎ¿Î® Î»Î¯Î³Î¿ Î½Î± Ï„ÏÎ­Î¾ÎµÎ¹
          sleep 45

          # ÎÎ±Î½Î±Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î¿ Î¯Î´Î¹Î¿ config volume Ï„Î¿Ï… mc Î³Î¹Î± Î½Î± Î´ÎµÎ¹ Ï„Î¿ alias
          docker volume create mcconfig >/dev/null 2>&1 || true

          # set alias (idempotent)
          docker run --rm --network ${APP_NET} -v mcconfig:/root/.mc \
            minio/mc alias set ${MINIO_ALIAS} ${MINIO_URL} ${MINIO_USER} ${MINIO_PASS} >/dev/null 2>&1 || true

          echo "=== Î›Î¯ÏƒÏ„Î± Î±Î½Ï„Î¹ÎºÎµÎ¹Î¼Î­Î½Ï‰Î½ ÏƒÏ„Î¿ bucket ${MINIO_BUCKET} ==="
          docker run --rm --network ${APP_NET} -v mcconfig:/root/.mc \
            minio/mc ls ${MINIO_ALIAS}/${MINIO_BUCKET} || true

          echo "=== Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Î³Î¹Î± Î±ÏÏ‡ÎµÎ¯Î± flight-* ==="
          docker run --rm --network ${APP_NET} -v mcconfig:/root/.mc \
            minio/mc find ${MINIO_ALIAS}/${MINIO_BUCKET} -name 'flight-*' -print || true

          echo "=== Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬ bucket ==="
          docker run --rm --network ${APP_NET} -v mcconfig:/root/.mc \
            minio/mc stat ${MINIO_ALIAS}/${MINIO_BUCKET} || true
        '''
      }
    }

    stage('Archive bucket') {
      steps {
        sh '''
          echo "ğŸ“¦ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Ï zip Î¼Îµ ÏŒÎ»Î± Ï„Î± artifactsâ€¦"
          cd ${ART_DIR}
          zip -r ../flights-data.zip .
        '''
        archiveArtifacts artifacts: 'flights-data.zip', fingerprint: true
      }
    }

  }

  post {
    always {
      // ÎšÎ±Ï„Î­Î²Î±ÏƒÎµ Ï„Î± services Î±Î»Î»Î¬ ÎœÎ— ÏƒÎ²Î®Î½ÎµÎ¹Ï‚ volumes Î³Î¹Î± Î½Î± Î¼Î· Ï‡Î¬Î½Î¿Î½Ï„Î±Î¹ credentials/bucket
      sh 'docker compose -f ${APP_COMPOSE} down || true'
    }
  }
}
